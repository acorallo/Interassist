@model InterAssistMVC.Models.Case

@{
    /*** EGV 25May2017 Creación de Archivo para la Vista de Edición de Casos ***/
    ViewBag.Title = "Caso";
    Layout = "~/Views/Shared/InterAssistLayout.cshtml";
}

@using (Html.BeginForm("Edit", "Case",FormMethod.Post, new { onsubmit = "AntesDeSubmit();" }))
{
    @Html.AntiForgeryToken()

    <h1 class="page-header">@ViewBag.Title</h1>
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="form-group">
                        <div class="col-lg-3"><label>Número de Caso:</label></div>
                        <div class="col-lg-2"><span class="form-control-static">@Html.DisplayFor(model => model.Id)</span></div>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-lg-2"><p class="form-control-static">Vehículo</p></div>
                        @{
    if (Model.IdEstado != 4)
    {
        <div class="col-lg-2"><p class="form-control-static">@Html.DisplayFor(model => model.Patente)</p></div>
                            <div class="col-lg-5"><p class="form-control-static">@Html.DisplayFor(model => model.NombreAfiliado)</p></div>
    }
    else
    {
        <div class="col-lg-1"><p class="form-control-static">Afiliado</p></div>
                                    <!--div class="col-lg-6"><input type="text" class="form-control" id="busq-afil"/></div-->
                            <div class="col-lg-6">
                                @(Html.X().ComboBox()
                                            .DisplayField("PatenteApeYNom")
                                            .ValueField("DatosAfiliado")
                                            .TypeAhead(false)
                                            .Value(Model.Afiliado != null ? Model.Afiliado.PatenteApeYNom : null)
        //.Width(new System.Web.UI.WebControls.Unit(100,System.Web.UI.WebControls.UnitType.Percentage))
                                            .Width(400)
                                            .PageSize(10)
                                            .HideTrigger(true)
                                            .MinChars(2)
                                            .TriggerAction(TriggerAction.Query)
                                            .ListConfig(Html.X().BoundList()
                                                .LoadingText("Buscando...")
                                                .ItemTpl(Html.X().XTemplate()
                                                    .Html(@<text>
                                                    <div class="search-item">
                                                        <strong>{PatenteApeYNom}</strong><br />
                                                        {Id} {Poliza} {NombreEmpresa} {NombreCategoria} {Documento}
                                                    </div>
                                                    </text>
                        )
                    )
                )
                .Listeners(ls => ls.Select.Handler = "EligeAfiliado(item);")
                .Store(Html.X().Store()
                    .AutoLoad(false)
                    .Proxy(Html.X().AjaxProxy()
                        .Url(Url.Action("TraeAfiliados"))
                        .ActionMethods(af => af.Read = HttpMethod.POST)
                        .Reader(Html.X().JsonReader().RootProperty("data"))
                    )
                    .Model(Html.X().Model()
                        .Fields(
                            Html.X().ModelField().Name("Id"),
                            Html.X().ModelField().Name("Patente"),
                            Html.X().ModelField().Name("ApellidoYNombre"),
                            Html.X().ModelField().Name("NombreEmpresa"),
                            Html.X().ModelField().Name("NombreCategoria"),
                            Html.X().ModelField().Name("Poliza"),
                            Html.X().ModelField().Name("Documento"),
                            Html.X().ModelField().Name("DatosAfiliado")
                        )
                    )
                )
                                )
                            </div>
    }
                        }
                        <div>@Html.HiddenFor(model => model.IdAfiliado)</div>
                        <div class="col-lg-3">@Html.DropDownListFor(model => model.IdEstado, Model.CaseEstados, new { @class = "form-control" })</div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="panel-body">
                                <!-- Nav tabs -->
                                <ul class="nav nav-tabs" style="margin-bottom:10px;">
                                    <li class="active">
                                        <a href="#afiliado" data-toggle="tab" aria-expanded="false">Afiliado</a>
                                    </li>
                                    <li class="">
                                        <a href="#ubicacion" data-toggle="tab" aria-expanded="false">Ubicación</a>
                                    </li>
                                    <li class="">
                                        <a href="#prestaciones" data-toggle="tab" aria-expanded="true">Prestaciones</a>
                                    </li>
                                    <li class="">
                                        <a href="#modificaciones" data-toggle="tab" aria-expanded="false">Modificaciones</a>
                                    </li>
                                </ul>

                                <!-- Tab panes -->
                                <div class="tab-content">
                                    <div class="tab-pane fade active in" id="afiliado">
                                        <!--div class="row">
                                            <div class="col-lg-2"><p class="form-control-static">Patente:</p></div>
                                            <div class="col-lg-2"><input type="text" class="form-control" value="ETF144" /></div>
                                        </div-->
                                        <div class="row">
                                            <div class="col-lg-8">@Html.EditorFor(model => model.NombreAfiliado, new { htmlAttributes = new { @class = "form-control", @placeholder = "Ingrese Nombre y Apellido", @disabled = "disabled", @id = "ApyNom" } })@Html.HiddenFor(model => model.Afiliado.Nombre)@Html.HiddenFor(model => model.Afiliado.Apellido)</div>
                                            <div class="col-lg-2">@Html.EditorFor(model => model.Afiliado.Documento, new { htmlAttributes = new { @class = "form-control", @placeholder = "Documento", @disabled = "disabled", @id = "Doc" } })</div>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-8">@Html.EditorFor(model => model.Afiliado.Direccion, new { htmlAttributes = new { @class = "form-control", @placeholder = "Ingrese Dirección: calle número, localidad, provincia", @disabled = "disabled", @id = "Dir" } })</div>
                                            <div class="col-lg-2">@Html.EditorFor(model => model.Afiliado.CodigoPostal, new { htmlAttributes = new { @class = "form-control", @placeholder = "Ingrese CP", @disabled = "disabled", @id = "cp" } })</div>
                                        </div>
                                        <div class="row">
                                            <h4 class="col-lg-12">Póliza</h4>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-2">@Html.EditorFor(model => model.Afiliado.Poliza, new { htmlAttributes = new { @class = "form-control", @placeholder = "Número", @disabled = "disabled", @id = "pol" } })</div>
                                            <div class="col-lg-3">@Html.EditorFor(model => model.Afiliado.NombreEmpresa, new { htmlAttributes = new { @class = "form-control", @placeholder = "Compañía", @disabled = "disabled", @id = "cia" } })</div>
                                            <div class="col-lg-2">@Html.EditorFor(model => model.Afiliado.FechaDesde, new { htmlAttributes = new { @class = "form-control", @placeholder = "dd/mm/yyyy", @disabled = "disabled", @id = "fd" } })</div>
                                            <div class="col-lg-2">@Html.EditorFor(model => model.Afiliado.FechaHasta, new { htmlAttributes = new { @class = "form-control", @placeholder = "dd/mm/yyyy", @disabled = "disabled", @id = "fh" } })</div>
                                            <div class="col-lg-3"><div class="checkbox"><label><input type="checkbox" disabled />Vigente</label></div></div>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-4"><input type="text" class="form-control" value="" placeholder="Tipo Poliza" disabled /></div>
                                            <div class="col-lg-4"><input type="text" class="form-control" value="" placeholder="Sub Tipo de Póliza" disabled /></div>
                                        </div>
                                        <div class="row">
                                            <h4 class="col-lg-12">Vehículo</h4>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-2">@Html.EditorFor(model => model.Afiliado.Patente, new { htmlAttributes = new { @class = "form-control", @placeholder = "Patente", @disabled = "disabled", @id = "pat" } })</div>
                                            <div class="col-lg-3">@Html.EditorFor(model => model.Afiliado.Marca, new { htmlAttributes = new { @class = "form-control", @placeholder = "Marca", @disabled = "disabled", @id = "marca" } })</div>
                                            <div class="col-lg-3">@Html.EditorFor(model => model.Afiliado.Modelo, new { htmlAttributes = new { @class = "form-control", @placeholder = "Modelo", @disabled = "disabled", @id = "mod" } })</div>
                                            <div class="col-lg-2">@Html.EditorFor(model => model.Afiliado.Color, new { htmlAttributes = new { @class = "form-control", @placeholder = "Color", @disabled = "disabled", @id = "col" } })</div>
                                            <div class="col-lg-2">@Html.EditorFor(model => model.Afiliado.Anio, new { htmlAttributes = new { @class = "form-control", @placeholder = "Año", @disabled = "disabled", @id = "anio" } })</div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="ubicacion">
                                        <div class="row"></div>
                                        <div class="row">
                                            <div class="col-lg-12"><label>Origen:</label>@Html.EditorFor(model => model.UbicacionOrigen, new { htmlAttributes = new { @class = "form-control", @placeholder = "Ingrese Dirección: calle número, localidad, provincia" } })@Html.HiddenFor(model => model.CalleOrigen)@Html.HiddenFor(model => model.IdLocalidadOrigen)@Html.HiddenFor(model => model.IdCiudadOrigen)@Html.HiddenFor(model => model.IdProvinciaOrigen)@Html.HiddenFor(model => model.IdPaisOrigen)</div>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-12"><label>Destino:</label>@Html.EditorFor(model => model.UbicacionDestino, new { htmlAttributes = new { @class = "form-control", @placeholder = "Ingrese Dirección: calle número, localidad, provincia" } })@Html.HiddenFor(model => model.CalleDestino)@Html.HiddenFor(model => model.IdLocalidadDestino)@Html.HiddenFor(model => model.IdCiudadDestino)@Html.HiddenFor(model => model.IdProvinciaDestino)@Html.HiddenFor(model => model.IdPaisDestino)</div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="prestaciones">
                                        <div class="row">
                                            <div class="col-lg-12">
                                                <p>
                                                    <button id="btnPrestacionAgregar" type="button" class="btn btn-success" onclick="AgregarPrestacion()" data-toggle="modal" data-target="#modalPrestacion" data-placement="top" title="Agregar Prestación">Nueva Prestación</button>
                                                    <button id="btnPrestacionModificar" type="button" class="btn btn-success" onclick="" data-toggle="modal" data-target="#modalPrestacion" data-placement="top" title="Agregar Prestación" style="display:none">Modificar Prestación</button>
                                                </p>

                                                <div class="modal fade" id="modalPrestacion" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
                                                    <div class="modal-dialog" style="width:80%">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                                <h4 class="modal-title" id="myModalLabel">Prestaciones</h4>
                                                            </div>
                                                            <div class="modal-body">
                                                                <div class="row">
                                                                    <div class="col-lg-3"><label>Tipo:</label>@Html.DropDownList("prestacionTipoServicio", Model.TiposServicio, new { @class = "form-control", @id = "prestacionTipoServicio" })</div>
                                                                    <div class="col-lg-3"><label>Problema:</label>@Html.DropDownList("prestacionProblema", Model.Problemas, new { @class = "form-control", @id = "prestacionProblema" })</div>
                                                                    <div class="col-lg-3"><label>Estado:</label>@Html.DropDownList("prestEstados", Model.PrestacionEstados, new { @class = "form-control", @id = "prestacionProblema" })</div>
                                                                    <div class="col-lg-3"><label>Retrabajo:</label>@Html.DropDownList("prestacionRetrabajo", Model.PrestacionesRetrabajo, new { @class = "form-control", @id = "prestacionRetrabajo" })</div>
                                                                </div>
                                                                <div class="row">
                                                                    <div class="col-lg-6"><label>Detalles:</label><textarea class="form-control" id="prestacionDetalles" rows="4" style="margin: 0px -3.83333px 0px 0px; width: 100%; height: 150px;"></textarea></div>
                                                                    <div class="col-lg-6">
                                                                        <div class="row">
                                                                            <div class="col-lg-12"><label>Prestador:</label><div class="form-group input-group"><input type="text" id="prestacionNombre" class="form-control"><span class="input-group-btn"><button class="btn btn-default" type="button"><i class="fa fa-search"></i></button></span></div></div>
                                                                        </div>
                                                                        <div class="row">
                                                                            <div class="col-lg-6"><label>Demora:</label><input type="text" id="prestacionDemora" class="form-control"></div>
                                                                            <div class="col-lg-6"><label>Patente:</label><input type="text" id="prestacionPatente" class="form-control"></div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="row">
                                                                    <div class="col-lg-6"><label>Origen:</label><input type="text" class="form-control" placeholder="Ingrese Dirección: calle número, localidad, provincia" /></div>
                                                                    <div class="col-lg-6"><label>Nombre conductor de Grúa:</label><input type="text" id="prestacionNombreChofer" class="form-control"></div>
                                                                </div>
                                                                <div class="row">
                                                                    <div class="col-lg-6"><label>Destino:</label><input type="text" class="form-control" placeholder="Ingrese Dirección: calle número, localidad, provincia" /></div>
                                                                    <div class="col-lg-3"><label>Kilómetros:</label><input type="text" id="prestacionKilometros" class="form-control"></div>
                                                                    <div class="col-lg-3"><label>Costo:</label><input type="text" id="prestacionCosto" class="form-control" disabled></div>
                                                                </div>
                                                                <div class="row">

                                                                </div>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                                                                <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="AceptarPrestacion();">Aceptar</button>
                                                            </div>
                                                        </div>
                                                        <!-- /.modal-content -->
                                                    </div>
                                                    <!-- /.modal-dialog -->
                                                </div>


                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-12">
                                                <div class="panel-body">
                                                    @(Html.X().ResourceManager())
                                                   @Html.HiddenFor(model => model.DatosPrestaciones)
                                                    <table id="gridPrestaciones" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
                                                        <thead>
                                                            <tr>
                                                                <th>Prestador</th>
                                                                <th>Servicio</th>
                                                                <th>Problema</th>
                                                                <th>Estado</th>
                                                                <th style="display:none">Id</th>
                                                                <th style="display:none">DatosPrestacion</th>
                                                                <!--th>IdProblema</th>
                                                                <th>IdPrestador</th>

                                                                <th>IdPrestador</th>
                                                                <th>IdTipoServicio</th>
                                                                <th>Comentarios</th>
                                                                <th>Kilometros</th>
                                                                <th>Costo</th>
                                                                <th>IdPaisOrigen</th>
                                                                <th>IdPaisDestino</th>
                                                                <th>IdProvinciaOrigen</th>
                                                                <th>IdProvinciaDestino</th>
                                                                <th>IdCiudadOrigen</th>

                                                                <th>IdCiudadOrigen</th>
                                                                <th>IdCiudadDestino</th>
                                                                <th>CalleOrigen</th>
                                                                <th>IdLocalidadOrigen</th>
                                                                <th>IdLocalidadDestino</th>
                                                                <th>CalleDestino</th-->
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (InterAssistMVC.Models.Prestacion p in Model.Prestaciones)
                                                            {
                                                                <tr ondblclick="ModificarPrestacion(this);">
                                                                    <td>@p.NombrePrestador</td>
                                                                    <td>@p.DescripcionServicio</td>
                                                                    <td>@p.Problema</td>
                                                                    <td>@p.IdEstado</td>
                                                                    <td style="display:none">@p.Id</td>
                                                                    <td style="display:none">@Newtonsoft.Json.JsonConvert.SerializeObject(p)</td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>


                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="modificaciones">
                                        <p>Grilla con las Fechas-Horas, Operador y Estado del Ticket, de todas las veces que se grabó el ticket</p>
                                        <p>De solo visualización</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row botonera">
                    <div class="col-lg-12">
                        <input type="submit" value="Grabar" class="btn btn-primary" style="float:right;margin-right:20px;"/>
                        <input type="button" value="Cancelar" class="btn btn-default" onclick="javascript: window.location.assign('@Url.Action("Index", "Case", null)')" style="float:right;margin-right:20px;" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var gridPrestacionRow;
        var prestacionAceptar = false;
        var accionPrestacion = "N";     // N = Nothing - A: Add - U: Update

        /*$('#gridPrestaciones').DataTAble({
            "columnDefs":[
                {
                    "targets": [4],
                    "visible":false
                },
                {
                    "targets": [5],
                    "visible":false
                }
            ]
        });*/


        function EligeAfiliado(item) {
            if (item != undefined && item != null) {
                var a = JSON.parse(item.value);
                $('input#IdAfiliado').val(a.Id);
                $('input#ApyNom').val(a.ApyNom);
                $('input#Doc').val(a.Doc);
                $('input#Dir').val(a.Dir);
                $('input#cp').val(a.cp);
                $('input#pol').val(a.pol);
                $('input#cia').val(a.cia);
                $('input#fd').val(a.fd);
                $('input#fh').val(a.fh);
                $('input#tp').val(a.tp);
                $('input#sp').val(a.sp);
                $('input#pat').val(a.pat);
                $('input#marca').val(a.marca);
                $('input#mod').val(a.mod);
                $('input#col').val(a.col);
                $('input#anio').val(a.anio);
            }
        }

        function AgregarPrestacion(grid) {
            prestacionAceptar = false;
            accionPrestacion = "A";
        }

        function ModificarPrestacion(data) {
            prestacionAceptar = false;
            accionPrestacion = "U";
            gridPrestacionRow = $(data);
            $('button#btnPrestacionModificar').click();
        }

        function AceptarPrestacion() {
            prestacionAceptar = true;
            var prestacion = Object();
            if (accionPrestacion == "A") {
                var a = $('#gridPrestaciones tbody');
                a.prepend('<tr ondblclick="ModificarPrestacion(this);"><td></td><td></td><td></td><td>-1</td><td style="display:none"></td><td style="display:none">{"Id":-1,"IdPrestador":-1,"NombrePrestador":"","IdTipoServicio":-1,"DescripcionServicio":"","Comentarios":"","Kilometros":-1,"Costo":-1,"IdProblema":-1,"Problema":null,"IdPaisOrigen":-1,"IdPaisDestino":-1,"IdProvinciaOrigen":-1,"IdProvinciaDestino":-1,"IdCiudadOrigen":-1,"IdCiudadDestino":-1,"CalleOrigen":"","IdLocalidadOrigen":-1,"IdLocalidadDestino":-1,"CalleDestino":"","IdEstado":-1,"IdTicketPrestadorRetrabajo":-1,"Demora":"","Patente":"","NombreChofer":"","Estado":null}</td></tr>')
                gridPrestacionRow = $(a.children()[0]);
            }
            prestacion = JSON.parse(gridPrestacionRow.children()[5].innerText);
            prestacion.NombrePrestador = $('#prestacionNombre').val();
            prestacion.IdTipoServicio = $('#prestacionTipoServicio').val();
            prestacion.DescripcionServicio = $('#prestacionTipoServicio option:selected').text();
            prestacion.Comentarios = $("#prestacionDetalles").val();
            prestacion.Kilometros = $('#prestacionKilometros').val();
            prestacion.Costo = $('#prestacionCosto').val();
            prestacion.IdProblema = $('#prestacionProblema').val();
            prestacion.Problema = $('#prestacionProblema option:selected').text();
            /*prestacion.IdPaisOrigen = ;
            prestacion.IdPaisDestino = ;
            prestacion.IdProvinciaOrigen = ;
            prestacion.IdProvinciaDestino = ;
            prestacion.IdCiudadOrigen = ;
            prestacion.IdCiudadDestino = ;
            prestacion.CalleOrigen = ;
            prestacion.IdLocalidadOrigen = ;
            prestacion.IdLocalidadDestino = ;
            prestacion.CalleDestino = ;*/
            prestacion.IdEstado = $('#prestacionEstado').val();
            prestacion.IdTicketPrestadorRetrabajo = $('#prestacionRetrabajo').val();
            prestacion.Demora = $('#prestacionDemora').val();
            prestacion.Patente = $('#prestacionPatente').val();
            prestacion.NombreChofer = $('#prestacionNombreChofer').val();

            gridPrestacionRow.children()[0].innerText = prestacion.NombrePrestador;
            gridPrestacionRow.children()[1].innerText = prestacion.DescripcionServicio;
            gridPrestacionRow.children()[2].innerText = prestacion.Problema;

            gridPrestacionRow.children()[5].innerText = JSON.stringify(prestacion);

        }

        function AntesDeSubmit() {
            var a = Array();

            for (i = 0; i < $('#gridPrestaciones tbody').children().length ; i++) {
                var p = JSON.parse($($('#gridPrestaciones tbody').children()[i]).children()[5].innerText);
                if (p.Kilometros == null || p.Kilometros == "") {
                    p.Kilometros = -1;
                }
                if (p.Costo == null || p.Costo == "") {
                    p.Costo = -1;
                }
                if (p.IdTipoServicio == null || p.IdTipoServicio == "") {
                    p.IdTipoServicio = -1;
                }
                if (p.IdProblema == null || p.IdProblema == "") {
                    p.IdProblema = -1;
                }
                if (p.IdPaisOrigen == null || p.IdPaisOrigen == "") {
                    p.IdPaisOrigen = -1;
                }
                if (p.IdPaisDestino == null || p.IdPaisDestino == "") {
                    p.IdPaisDestino = -1;
                }
                if (p.IdProvinciaOrigen == null || p.IdProvinciaOrigen == "") {
                    p.IdProvinciaOrigen = -1;
                }
                if (p.IdProvinciaDestino == null || p.IdProvinciaDestino == "") {
                    p.IdProvinciaDestino = -1;
                }
                if (p.IdCiudadOrigen == null || p.IdCiudadOrigen == "") {
                    p.IdCiudadOrigen = -1;
                }
                if (p.IdCiudadDestino == null || p.IdCiudadDestino == "") {
                    p.IdCiudadDestino = -1;
                }
                if (p.IdLocalidadOrigen == null || p.IdLocalidadOrigen == "") {
                    p.IdLocalidadOrigen = -1;
                }
                if (p.IdLocalidadDestino == null || p.IdLocalidadDestino == "") {
                    p.IdLocalidadDestino = -1;
                }
                if (p.IdEstado == null || p.IdEstado == "") {
                    p.IdEstado = -1;
                }
                if (p.IdTicketPrestadorRetrabajo == null || p.IdTicketPrestadorRetrabajo == "") {
                    p.IdTicketPrestadorRetrabajo = -1;
                }
                if (p.Id == null || p.Id == "") {
                    p.Id = -1;
                }
                a.push(p);
            }
            $('#DatosPrestaciones').val(JSON.stringify(a));
        }
    </script>

}




